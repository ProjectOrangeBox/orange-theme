!function($){"use strict";var t=function(t,e,n){var a,o,i,r=null,l=0;n||(n={});var s=function(){l=!1===n.leading?0:$.now(),r=null,i=t.apply(a,o),r||(a=o=null)};return function(){var d=$.now();l||!1!==n.leading||(l=d);var c=e-(d-l);return a=this,o=arguments,c<=0||c>e?(r&&(clearTimeout(r),r=null),l=d,i=t.apply(a,o),r||(a=o=null)):r||!1===n.trailing||(r=setTimeout(s,c)),i}},e=function(t){var e=$.Deferred(),n=new FileReader;return n.onload=function(t){e.resolve(t.target.result)},n.onerror=e.reject,n.onprogress=e.notify,n.readAsDataURL(t),e.promise()};$.fn.cleanHtml=function(t){if(!0===$(this).data("wysiwyg-html-mode")&&($(this).html($(this).text()),$(this).attr("contenteditable",!0),$(this).data("wysiwyg-html-mode",!1)),!0===t&&$(this).parent().is("form")){var e=$(this).html;if($(e).has("img").length){var n=$("img",$(e)),a=[],o=$(this).parent();$.each(n,function(t,e){$(e).attr("src").match(/^data:image\/.*$/)&&(a.push(n[t]),$(o).prepend("<input value='"+$(e).attr("src")+"' type='hidden' name='postedimage/"+t+"' />"),$(e).attr("src","postedimage/"+t))})}}var i=$(this).html();return i&&i.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},$.fn.wysiwyg=function(n){var a=this,o,i,r,l=function(){i.activeToolbarClass&&$(i.toolbarSelector).find(r).each(function(){var t=$(this).data(i.commandRole).split(" "),e=t[0];t.length>1&&document.queryCommandEnabled(e)&&document.queryCommandValue(e)===t[1]?$(this).addClass(i.activeToolbarClass):1===t.length&&document.queryCommandEnabled(e)&&document.queryCommandState(e)?$(this).addClass(i.activeToolbarClass):$(this).removeClass(i.activeToolbarClass)})},s=function(e,n){var o=e.split(" "),r=o.shift(),s=o.join(" ")+(n||""),d=e.split("-");1===d.length?t(document.execCommand(r,!1,s),i.keypressTimeout):"format"===d[0]&&2===d.length&&t(document.execCommand("formatBlock",!1,d[1]),i.keypressTimeout),a.trigger("change"),l()},d=function(e){$.each(e,function(e,n){a.keydown(e,function(e){a.attr("contenteditable")&&a.is(":visible")&&(e.preventDefault(),e.stopPropagation(),t(s(n),i.keypressTimeout))}).keyup(e,function(t){a.attr("contenteditable")&&a.is(":visible")&&(t.preventDefault(),t.stopPropagation())})}),a.keyup(function(){a.trigger("change")})},c=function(){var t,e;return window.getSelection?(t=window.getSelection(),t.getRangeAt&&t.rangeCount&&(e=t.getRangeAt(0))):document.selection&&(e=document.selection.createRange()),e},u=function(){o=c()},m=function(){var t;if(window.getSelection||document.createRange){if(t=window.getSelection(),o){try{t.removeAllRanges()}catch(t){document.body.createTextRange().select(),document.selection.empty()}t.addRange(o)}}else document.selection&&o&&o.select()},h=function(){if(!0!==$(a).data("wysiwyg-html-mode")){var t=$(a).html(),e=$("<pre />");$(e).append(document.createTextNode(t)),$(e).attr("contenteditable",!0),$(a).html(" "),$(a).append($(e)),$(a).attr("contenteditable",!1),$(a).data("wysiwyg-html-mode",!0),$(e).focus()}else $(a).html($(a).text()),$(a).attr("contenteditable",!0),$(a).data("wysiwyg-html-mode",!1),$(a).focus()},f=function(n){a.focus(),$.each(n,function(n,o){/^image\//.test(o.type)?$.when(e(o)).done(function(e){t(s("insertimage",e),i.keypressTimeout),a.trigger("image-inserted")}).fail(function(t){i.fileUploadError("file-reader",t)}):i.fileUploadError("unsupported-file-type",o.type)})},p=function(e,n){m(),document.queryCommandSupported("hiliteColor")&&t(document.execCommand("hiliteColor",!1,n||"transparent"),i.keypressTimeout),u(),e.data(i.selectionMarker,n)},g=function(e,n){e.find(r).click(function(){m(),a.focus(),"html"===$(this).data(n.commandRole)?h():t(s($(this).data(n.commandRole)),n.keypressTimeout),u()}),e.find("[data-toggle=dropdown]").click(m),e.find("input[type=text][data-"+n.commandRole+"]").on("webkitspeechchange change",function(){var e=this.value;this.value="",m(),e&&(a.focus(),t(s($(this).data(n.commandRole),e),n.keypressTimeout)),u()}).on("focus",function(){var t=$(this);t.data(n.selectionMarker)||(p(t,n.selectionColor),t.focus())}).on("blur",function(){var t=$(this);t.data(n.selectionMarker)&&p(t,!1)}),e.find("input[type=file][data-"+n.commandRole+"]").change(function(){m(),"file"===this.type&&this.files&&this.files.length>0&&f(this.files),u(),this.value=""})},y=function(){a.on("dragenter dragover",!1).on("drop",function(t){var e=t.originalEvent.dataTransfer;t.stopPropagation(),t.preventDefault(),e&&e.files&&e.files.length>0&&f(e.files)})};return i=$.extend(!0,{},$.fn.wysiwyg.defaults,n),r="a[data-"+i.commandRole+"],button[data-"+i.commandRole+"],input[type=button][data-"+i.commandRole+"]",d(i.hotKeys),""!==$(this).attr("placeholder")&&($(this).addClass("placeholderText"),$(this).html($(this).attr("placeholder")),$(this).bind("focus",function(){""!==$(this).attr("placeholder")&&$(this).text()===$(this).attr("placeholder")&&($(this).removeClass("placeholderText"),$(this).html(""))}),$(this).bind("blur",function(){""!==$(this).attr("placeholder")&&""===$(this).text()&&($(this).addClass("placeholderText"),$(this).html($(this).attr("placeholder")))})),i.dragAndDropImages&&y(),g($(i.toolbarSelector),i),a.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){u(),l()}),$(window).bind("touchend",function(t){var e=a.is(t.target)||a.has(t.target).length>0,n=c();n&&n.startContainer===n.endContainer&&n.startOffset===n.endOffset&&!e||(u(),l())}),this},$.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(t,e){console.log("File upload error",t,e)}}}(window.jQuery);